================================================================================
PROJETO: BUSSOLA-V2
DATA: 24/12/2025
TIPO: Planejamento Técnico e Histórico de Refatoração
================================================================================

1. DIAGNÓSTICO E REFATORAÇÃO (BACKEND)
--------------------------------------------------------------------------------
Objetivo: Preparar o sistema para escalar, suportar Docker e limpar a arquitetura.

A. MUDANÇAS ARQUITETURAIS REALIZADAS:
   - Padrão Service Layer: Lógica de negócio movida das rotas (endpoints) para os services.
   - Endpoints Magros: O arquivo de rota agora apenas valida entrada e chama o service.
   - Segurança de Dados: Remoção de criptografia automática nos Models (para não expor senhas em memória).
   - Multi-tenancy: Garantia de que todas as queries filtram por `user_id`.

B. ARQUIVOS MODIFICADOS/CORRIGIDOS:

   1. Finanças (Refatoração Completa):
      - Rota: `app/api/v1/endpoints/financas.py` (Limpa).
      - Service: `app/services/financas.py` (Recebeu toda a lógica de dashboard).
      - Melhorias: Proteção contra Race Condition na criação de categorias e otimização de performance nas transações recorrentes.

   2. Auth (Refatoração Completa):
      - Rota: `app/api/v1/endpoints/auth.py` (Limpa).
      - Service: `app/services/auth.py` (Recebeu lógica do Google, validação SaaS vs Self-Hosted e troca de requests por httpx async).

   3. Cofre (Hardening de Segurança):
      - Model: `app/models/cofre.py` (Removidos getters/setters mágicos).
      - Service: `app/services/cofre.py` (Criptografia explícita apenas ao salvar/ler senha específica).
      - Benefício: `get_all` não descriptografa mais senhas em memória.

   4. Ritmo / Configuração (Docker-Ready):
      - Config: `app/core/config.py` agora define `BASE_DIR` e `DATA_DIR` dinamicamente.
      - Service: `app/services/ritmo.py` usa `settings.DATA_DIR` para achar `taco.json`.
      - Benefício: Caminhos funcionam tanto local quanto no Docker.

   5. Infraestrutura de Banco:
      - DB: `app/db/session.py` agora detecta se é SQLite ou Postgres. Se for Postgres, remove argumentos exclusivos do SQLite.

   6. Correções de Bugs Pontuais:
      - `system.py`: Adicionado `APIRouter()` que faltava.
      - `auth.py`: Correção de nome de argumento (`google_token`).

================================================================================
2. PLANEJAMENTO DA NOVA FEATURE: INTEGRAÇÃO COM IA (AGENTS)
================================================================================
Objetivo: Criar uma IA contextualizada para cada página do sistema.

A. ARQUITETURA ESCOLHIDA: HIERARCHICAL MULTI-AGENT SYSTEM (Conselho de Especialistas)
   - Conceito: Cada página tem um "Chefe" (Orquestrador) e vários "Operários" (Agentes).
   - Fluxo:
     1. Frontend pede ajuda ->
     2. Orquestrador da Página recebe ->
     3. Agentes Especialistas analisam dados em paralelo ->
     4. Orquestrador consolida as opiniões e decide a melhor dica ->
     5. Frontend exibe.

B. ESTRUTURA DE DIRETÓRIOS PLANEJADA:
   app/services/ai/
   ├── base.py             # Interfaces (BaseAgent, BaseOrchestrator)
   ├── llm_client.py       # Cliente Groq/OpenAI
   ├── ritmo/              # DEPARTAMENTO RITMO
   │   ├── orchestrator.py # Líder
   │   └── agents/
   │       ├── nutri.py    # Especialista em Dieta
   │       ├── coach.py    # Especialista em Treino
   │       └── bio.py      # Especialista em Corpo
   ├── financas/           # DEPARTAMENTO FINANÇAS
   │   ├── orchestrator.py # Líder
   │   └── agents/
   │       ├── cfo.py      # Especialista em Fluxo
   │       └── auditor.py  # Especialista em Anomalias
   └── ... (outros departamentos)

C. DETALHAMENTO DOS AGENTES POR PÁGINA:

   1. RITMO (Saúde)
      - BioAgent: Monitora peso, BF e atualizações de medidas.
      - NutriAgent: Analisa ingestão calórica vs meta.
      - CoachAgent: Analisa volume de treino e frequência.

   2. FINANÇAS (Dinheiro)
      - CFO Agent: Monitora orçamento, metas e burn rate (velocidade de gasto).
      - Auditor Agent: Caça assinaturas fantasmas, gastos duplicados e anomalias.

   3. AGENDA (Tempo)
      - Secretary Agent: Gere conflitos, tempo de deslocamento e preparação para reuniões.

   4. REGISTROS (Produtividade)
      - Productivity Agent: Aplica Matriz de Eisenhower, sugere limpeza de tarefas velhas.

   5. COFRE (Segurança)
      - Security Agent: Analisa idade das senhas e duplicidade (apenas metadados).

================================================================================
3. PRÓXIMOS PASSOS IMEDIATOS
================================================================================
1. [INFRA] Criar Dockerfile e docker-compose.yml para rodar o ambiente completo.
2. [IA - CORE] Criar `app/services/ai/base.py` e configuração do cliente LLM.
3. [IA - RITMO] Implementar o primeiro módulo (Orquestrador + Agentes de Ritmo) como prova de conceito.